{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Introduction to Verisafe","text":"<p>Verisafe pronounced as 'Very Safe' is an Authentication and Authorization service for the Academia platform.</p> <p>Its primary functions are as follows.</p> <ol> <li>Interfaces between other Oauth providers such as Google and Apple</li> <li>Manages user accounts and user profiles on the Academia platform</li> <li>Manages user roles and permissions on the platform</li> <li>Provides user information to other services on the Academia platform.</li> <li>Providence of supported institutions on the platform</li> </ol>"},{"location":"#the-need-for-verisafe","title":"The need for Verisafe","text":"<p>The Academia platform is huge with multiple services requiring information about core critical components such as </p> <ul> <li>User information</li> <li>User roles and permissions</li> <li>A way to authenticate a user against their auth provider such as Google</li> <li>A centralized place for profile and user management</li> <li>A way to authorize service to service communication.</li> </ul> <p>If every service was to handle these mentioned issues, the code bases would grow, chances of errors would also grow  exponentially with also the risk of services having stale or incorrect information leading to either a buggy or  erroneous processing of data leading to incorrect results or information on the platform</p> <p>To counter this the Verisafe service was created and delegated with the role of being the only source of truth for  the above mentioned roles.</p> <p>At any given point, Verisafe's information is final regarding the roles it plays and is not to be debated.</p>"},{"location":"#environments","title":"Environments","text":"<p>Verisafe has three primary roles of operation</p> <ul> <li>Development mode - Run locally on the developer's machine</li> <li>Staging mode - Deployed upon a push to the remote repository triggered by CI/CD pipeline</li> <li>Production mode - The client facing version of the project thats  merged into the main branch of the project</li> </ul> <p>More about the environments will be discussed later</p>"},{"location":"BOT_ACCOUNT_CREATION/","title":"Bot Account Creation Guide","text":"<p>This guide explains how to create bot accounts in Verisafe with enhanced service tokens that follow industry-standard security practices.</p>"},{"location":"BOT_ACCOUNT_CREATION/#overview","title":"Overview","text":"<p>Bot accounts are special accounts designed for automated services, microservices, and API integrations. They can only be created by users with appropriate permissions and come with enhanced service tokens that provide secure API access.</p>"},{"location":"BOT_ACCOUNT_CREATION/#prerequisites","title":"Prerequisites","text":"<p>Before creating a bot account, ensure you have:</p> <ol> <li>Valid Authentication: A valid JWT token for a user account</li> <li>Required Permissions: The <code>create:account:any</code> permission</li> <li>API Access: Access to the Verisafe API endpoints</li> </ol>"},{"location":"BOT_ACCOUNT_CREATION/#authentication","title":"Authentication","text":"<p>All bot account creation requests require authentication. Include your JWT token in the Authorization header:</p> <pre><code>Authorization: Bearer &lt;your_jwt_token&gt;\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#creating-a-bot-account","title":"Creating a Bot Account","text":""},{"location":"BOT_ACCOUNT_CREATION/#endpoint","title":"Endpoint","text":"<pre><code>POST /accounts/bot/create\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#request-format","title":"Request Format","text":"<p>The request body should be a JSON object with two main sections:</p> <pre><code>{\n  \"account\": {\n    \"email\": \"string (required)\",\n    \"name\": \"string (required)\",\n    \"avatar_url\": \"string (optional)\"\n  },\n  \"service_token\": {\n    \"name\": \"string (required)\",\n    \"description\": \"string (optional)\",\n    \"expires_in_days\": \"integer (optional, 1-3650)\",\n    \"scopes\": [\"array of strings (optional)\"],\n    \"max_uses\": \"integer (optional, minimum 1)\",\n    \"rotation_policy\": {\n      \"auto_rotate\": \"boolean\",\n      \"rotation_interval_days\": \"integer (1-365)\",\n      \"notify_before_days\": \"integer (1-30)\"\n    },\n    \"ip_whitelist\": [\"array of IP addresses (optional)\"],\n    \"user_agent_pattern\": \"regex pattern (optional)\",\n    \"metadata\": {\n      \"key\": \"value (optional)\"\n    }\n  }\n}\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#field-descriptions","title":"Field Descriptions","text":""},{"location":"BOT_ACCOUNT_CREATION/#account-fields","title":"Account Fields","text":"<ul> <li>email (required): A valid email address for the bot account</li> <li>name (required): A descriptive name for the bot account (1-100 characters)</li> <li>avatar_url (optional): URL to an avatar image for the bot account</li> </ul>"},{"location":"BOT_ACCOUNT_CREATION/#service-token-fields","title":"Service Token Fields","text":"<ul> <li>name (required): A descriptive name for the service token (1-100 characters)</li> <li>description (optional): Detailed description of the token's purpose</li> <li>expires_in_days (optional): Number of days until the token expires (1-3650, default: 365)</li> <li>scopes (optional): Array of permission scopes the token can access</li> <li>max_uses (optional): Maximum number of times the token can be used</li> <li>rotation_policy (optional): Configuration for automatic token rotation</li> <li>auto_rotate: Whether to automatically rotate the token</li> <li>rotation_interval_days: Days between rotations (1-365)</li> <li>notify_before_days: Days before rotation to send notification (1-30)</li> <li>ip_whitelist (optional): Array of allowed IP addresses</li> <li>user_agent_pattern (optional): Regex pattern to validate user agent strings</li> <li>metadata (optional): Additional key-value pairs for custom data</li> </ul>"},{"location":"BOT_ACCOUNT_CREATION/#examples","title":"Examples","text":""},{"location":"BOT_ACCOUNT_CREATION/#basic-bot-account-creation","title":"Basic Bot Account Creation","text":"<pre><code>curl -X POST http://localhost:8080/accounts/bot/create \\\n  -H \"Authorization: Bearer &lt;your_jwt_token&gt;\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"account\": {\n      \"email\": \"mybot@company.com\",\n      \"name\": \"My Production Bot\"\n    },\n    \"service_token\": {\n      \"name\": \"Production API Key\",\n      \"description\": \"API key for production environment\"\n    }\n  }'\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#advanced-bot-account-with-full-configuration","title":"Advanced Bot Account with Full Configuration","text":"<pre><code>curl -X POST http://localhost:8080/accounts/bot/create \\\n  -H \"Authorization: Bearer &lt;your_jwt_token&gt;\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"account\": {\n      \"email\": \"production-bot@company.com\",\n      \"name\": \"Production Data Processor\",\n      \"avatar_url\": \"https://example.com/bot-avatar.png\"\n    },\n    \"service_token\": {\n      \"name\": \"Production Data API Key\",\n      \"description\": \"API key for production data processing services\",\n      \"expires_in_days\": 365,\n      \"scopes\": [\"read:data\", \"write:data\", \"process:reports\"],\n      \"max_uses\": 10000,\n      \"rotation_policy\": {\n        \"auto_rotate\": true,\n        \"rotation_interval_days\": 90,\n        \"notify_before_days\": 7\n      },\n      \"ip_whitelist\": [\"192.168.1.100\", \"10.0.0.50\"],\n      \"user_agent_pattern\": \"DataProcessor/.*\",\n      \"metadata\": {\n        \"environment\": \"production\",\n        \"team\": \"data-science\",\n        \"service\": \"data-processor\",\n        \"version\": \"1.0.0\"\n      }\n    }\n  }'\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#development-bot-account","title":"Development Bot Account","text":"<pre><code>curl -X POST http://localhost:8080/accounts/bot/create \\\n  -H \"Authorization: Bearer &lt;your_jwt_token&gt;\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"account\": {\n      \"email\": \"dev-bot@company.com\",\n      \"name\": \"Development Test Bot\"\n    },\n    \"service_token\": {\n      \"name\": \"Development API Key\",\n      \"description\": \"API key for development and testing\",\n      \"expires_in_days\": 30,\n      \"scopes\": [\"read:data\"],\n      \"max_uses\": 1000,\n      \"metadata\": {\n        \"environment\": \"development\",\n        \"team\": \"engineering\"\n      }\n    }\n  }'\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#response-format","title":"Response Format","text":""},{"location":"BOT_ACCOUNT_CREATION/#success-response-201-created","title":"Success Response (201 Created)","text":"<pre><code>{\n  \"account\": {\n    \"id\": \"550e8400-e29b-41d4-a716-446655440000\",\n    \"email\": \"mybot@company.com\",\n    \"name\": \"My Production Bot\",\n    \"type\": \"bot\",\n    \"created_at\": \"2025-01-01T00:00:00Z\"\n  },\n  \"service_token\": {\n    \"id\": \"550e8400-e29b-41d4-a716-446655440001\",\n    \"name\": \"Production API Key\",\n    \"description\": \"API key for production environment\",\n    \"token\": \"vst_abc123def456ghi789jkl012mno345pqr678stu901vwx234yz\",\n    \"expires_at\": \"2026-01-01T00:00:00Z\",\n    \"scopes\": [\"read:data\", \"write:data\"],\n    \"max_uses\": 10000,\n    \"created_at\": \"2025-01-01T00:00:00Z\",\n    \"metadata\": {\n      \"environment\": \"production\",\n      \"team\": \"backend\"\n    }\n  }\n}\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#error-responses","title":"Error Responses","text":""},{"location":"BOT_ACCOUNT_CREATION/#400-bad-request","title":"400 Bad Request","text":"<pre><code>{\n  \"error\": \"Email and name are required\"\n}\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#401-unauthorized","title":"401 Unauthorized","text":"<pre><code>{\n  \"error\": \"Missing Authorization or X-API-Key header\"\n}\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#403-forbidden","title":"403 Forbidden","text":"<pre><code>{\n  \"error\": \"You do not have the necessary permissions to perform this action\"\n}\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#500-internal-server-error","title":"500 Internal Server Error","text":"<pre><code>{\n  \"error\": \"We couldn't create this account at the moment please try again later\"\n}\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#using-the-service-token","title":"Using the Service Token","text":"<p>Once you have created a bot account and received the service token, you can use it to authenticate API requests:</p> <pre><code>curl -X GET http://localhost:8080/api/v1/some-endpoint \\\n  -H \"X-API-Key: vst_abc123def456ghi789jkl012mno345pqr678stu901vwx234yz\"\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#security-best-practices","title":"Security Best Practices","text":""},{"location":"BOT_ACCOUNT_CREATION/#1-token-storage","title":"1. Token Storage","text":"<ul> <li>Never store tokens in plain text</li> <li>Use secure secret management systems</li> <li>Rotate tokens regularly</li> <li>Monitor token usage</li> </ul>"},{"location":"BOT_ACCOUNT_CREATION/#2-ip-whitelisting","title":"2. IP Whitelisting","text":"<ul> <li>Restrict tokens to specific IP addresses when possible</li> <li>Use CIDR notation for IP ranges</li> <li>Regularly review and update whitelists</li> </ul>"},{"location":"BOT_ACCOUNT_CREATION/#3-scope-limitation","title":"3. Scope Limitation","text":"<ul> <li>Grant only the minimum required permissions</li> <li>Use specific scopes instead of broad permissions</li> <li>Regularly audit token permissions</li> </ul>"},{"location":"BOT_ACCOUNT_CREATION/#4-usage-monitoring","title":"4. Usage Monitoring","text":"<ul> <li>Monitor token usage patterns</li> <li>Set up alerts for unusual activity</li> <li>Track failed authentication attempts</li> </ul>"},{"location":"BOT_ACCOUNT_CREATION/#5-token-rotation","title":"5. Token Rotation","text":"<ul> <li>Enable automatic token rotation</li> <li>Set appropriate rotation intervals</li> <li>Plan for manual rotation when needed</li> </ul>"},{"location":"BOT_ACCOUNT_CREATION/#token-management","title":"Token Management","text":"<p>After creating a bot account, you can manage the service tokens using the service token management endpoints:</p> <ul> <li>List tokens: <code>GET /api/v1/service-tokens</code></li> <li>Get token details: <code>GET /api/v1/service-tokens/{id}</code></li> <li>Update token: <code>PUT /api/v1/service-tokens/{id}</code></li> <li>Rotate token: <code>POST /api/v1/service-tokens/{id}/rotate</code></li> <li>Revoke token: <code>DELETE /api/v1/service-tokens/{id}</code></li> </ul>"},{"location":"BOT_ACCOUNT_CREATION/#troubleshooting","title":"Troubleshooting","text":""},{"location":"BOT_ACCOUNT_CREATION/#common-issues","title":"Common Issues","text":"<ol> <li>Permission Denied</li> <li>Ensure your account has the <code>create:account:any</code> permission</li> <li> <p>Check that your JWT token is valid and not expired</p> </li> <li> <p>Invalid Request Body</p> </li> <li>Verify all required fields are present</li> <li>Check field validation rules (length limits, format requirements)</li> <li> <p>Ensure JSON is properly formatted</p> </li> <li> <p>Email Already Exists</p> </li> <li>Use a unique email address for each bot account</li> <li> <p>Check existing accounts before creating new ones</p> </li> <li> <p>Token Generation Failed</p> </li> <li>This is usually a server-side issue</li> <li>Contact system administrators if the problem persists</li> </ol>"},{"location":"BOT_ACCOUNT_CREATION/#validation-rules","title":"Validation Rules","text":"<ul> <li>Email: Must be a valid email format</li> <li>Name: 1-100 characters, required</li> <li>Token Name: 1-100 characters, required</li> <li>Expires In Days: 1-3650 days</li> <li>Max Uses: Minimum 1</li> <li>Rotation Interval: 1-365 days</li> <li>Notify Before Days: 1-30 days</li> </ul>"},{"location":"BOT_ACCOUNT_CREATION/#api-reference","title":"API Reference","text":"<p>For complete API documentation, see the Service Tokens Implementation Guide.</p>"},{"location":"BOT_ACCOUNT_CREATION/#support","title":"Support","text":"<p>If you encounter issues creating bot accounts:</p> <ol> <li>Check the error messages for specific guidance</li> <li>Verify your permissions and authentication</li> <li>Review the request format and validation rules</li> <li>Contact your system administrator for assistance</li> </ol>"},{"location":"BOT_ACCOUNT_CREATION/#examples-in-different-languages","title":"Examples in Different Languages","text":""},{"location":"BOT_ACCOUNT_CREATION/#python","title":"Python","text":"<pre><code>import requests\nimport json\n\ndef create_bot_account(jwt_token, account_data):\n    url = \"http://localhost:8080/accounts/bot/create\"\n    headers = {\n        \"Authorization\": f\"Bearer {jwt_token}\",\n        \"Content-Type\": \"application/json\"\n    }\n\n    response = requests.post(url, headers=headers, json=account_data)\n    return response.json()\n\n# Usage\naccount_data = {\n    \"account\": {\n        \"email\": \"mybot@company.com\",\n        \"name\": \"My Production Bot\"\n    },\n    \"service_token\": {\n        \"name\": \"Production API Key\",\n        \"description\": \"API key for production environment\"\n    }\n}\n\nresult = create_bot_account(\"your_jwt_token\", account_data)\nprint(f\"Bot account created: {result['account']['id']}\")\nprint(f\"Service token: {result['service_token']['token']}\")\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#javascriptnodejs","title":"JavaScript/Node.js","text":"<pre><code>async function createBotAccount(jwtToken, accountData) {\n    const response = await fetch('http://localhost:8080/accounts/bot/create', {\n        method: 'POST',\n        headers: {\n            'Authorization': `Bearer ${jwtToken}`,\n            'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(accountData)\n    });\n\n    return await response.json();\n}\n\n// Usage\nconst accountData = {\n    account: {\n        email: 'mybot@company.com',\n        name: 'My Production Bot'\n    },\n    service_token: {\n        name: 'Production API Key',\n        description: 'API key for production environment'\n    }\n};\n\ncreateBotAccount('your_jwt_token', accountData)\n    .then(result =&gt; {\n        console.log(`Bot account created: ${result.account.id}`);\n        console.log(`Service token: ${result.service_token.token}`);\n    })\n    .catch(error =&gt; console.error('Error:', error));\n</code></pre>"},{"location":"BOT_ACCOUNT_CREATION/#go","title":"Go","text":"<pre><code>package main\n\nimport (\n    \"bytes\"\n    \"encoding/json\"\n    \"fmt\"\n    \"net/http\"\n)\n\ntype BotAccountRequest struct {\n    Account struct {\n        Email     string  `json:\"email\"`\n        Name      string  `json:\"name\"`\n        AvatarUrl *string `json:\"avatar_url,omitempty\"`\n    } `json:\"account\"`\n    ServiceToken struct {\n        Name     string   `json:\"name\"`\n        Scopes   []string `json:\"scopes,omitempty\"`\n        MaxUses  *int     `json:\"max_uses,omitempty\"`\n    } `json:\"service_token\"`\n}\n\nfunc createBotAccount(jwtToken string, accountData BotAccountRequest) error {\n    jsonData, err := json.Marshal(accountData)\n    if err != nil {\n        return err\n    }\n\n    req, err := http.NewRequest(\"POST\", \"http://localhost:8080/accounts/bot/create\", bytes.NewBuffer(jsonData))\n    if err != nil {\n        return err\n    }\n\n    req.Header.Set(\"Authorization\", \"Bearer \"+jwtToken)\n    req.Header.Set(\"Content-Type\", \"application/json\")\n\n    client := &amp;http.Client{}\n    resp, err := client.Do(req)\n    if err != nil {\n        return err\n    }\n    defer resp.Body.Close()\n\n    if resp.StatusCode != http.StatusCreated {\n        return fmt.Errorf(\"failed to create bot account: %d\", resp.StatusCode)\n    }\n\n    return nil\n}\n\nfunc main() {\n    accountData := BotAccountRequest{}\n    accountData.Account.Email = \"mybot@company.com\"\n    accountData.Account.Name = \"My Production Bot\"\n    accountData.ServiceToken.Name = \"Production API Key\"\n\n    err := createBotAccount(\"your_jwt_token\", accountData)\n    if err != nil {\n        fmt.Printf(\"Error: %v\\n\", err)\n    } else {\n        fmt.Println(\"Bot account created successfully\")\n    }\n}\n</code></pre>"},{"location":"RABBITMQ_INTEGRATION/","title":"RabbitMQ Integration","text":"<p>Verisafe now includes RabbitMQ event publishing capabilities to notify other services about user events. This integration follows the same pattern as GossipMonger for consistency.</p>"},{"location":"RABBITMQ_INTEGRATION/#overview","title":"Overview","text":"<p>Verisafe publishes user events to RabbitMQ when: - A new user account is created during OAuth authentication - An existing user's social account is updated during OAuth authentication</p>"},{"location":"RABBITMQ_INTEGRATION/#configuration","title":"Configuration","text":"<p>Add the following environment variables to your <code>.env</code> file:</p> <pre><code># RabbitMQ Configuration\nRABBITMQ_USER=guest\nRABBITMQ_PASSWORD=guest\nRABBITMQ_ADDRESS=localhost\nRABBITMQ_PORT=5672\nRABBITMQ_EXCHANGE=verisafe.exchange\n</code></pre>"},{"location":"RABBITMQ_INTEGRATION/#event-types","title":"Event Types","text":""},{"location":"RABBITMQ_INTEGRATION/#user-created-event","title":"User Created Event","text":"<ul> <li>Routing Key: <code>verisafe.user.created</code></li> <li>Event Type: <code>user.created</code></li> <li>Published When: A new user account is created during OAuth authentication</li> </ul>"},{"location":"RABBITMQ_INTEGRATION/#user-updated-event","title":"User Updated Event","text":"<ul> <li>Routing Key: <code>verisafe.user.updated</code></li> <li>Event Type: <code>user.updated</code></li> <li>Published When: An existing user's social account is updated during OAuth authentication</li> </ul>"},{"location":"RABBITMQ_INTEGRATION/#event-structure","title":"Event Structure","text":"<p>All events follow this structure:</p> <pre><code>{\n  \"user\": {\n    \"id\": \"uuid\",\n    \"email\": \"user@example.com\",\n    \"name\": \"User Name\",\n    \"type\": \"human\",\n    \"avatar_url\": \"https://example.com/avatar.jpg\",\n    \"created_at\": \"2024-01-01T00:00:00Z\",\n    \"updated_at\": \"2024-01-01T00:00:00Z\"\n  },\n  \"meta\": {\n    \"event_type\": \"user.created\",\n    \"timestamp\": \"2024-01-01T00:00:00Z\",\n    \"source_service_id\": \"io.opencrafts.verisafe\",\n    \"request_id\": \"uuid\"\n  }\n}\n</code></pre>"},{"location":"RABBITMQ_INTEGRATION/#integration-with-gossipmonger","title":"Integration with GossipMonger","text":"<p>GossipMonger subscribes to these events using the same routing keys: - <code>verisafe.user.created</code> - <code>verisafe.user.updated</code> - <code>verisafe.user.deleted</code> (for future use)</p>"},{"location":"RABBITMQ_INTEGRATION/#error-handling","title":"Error Handling","text":"<ul> <li>If RabbitMQ is not configured, event publishing is disabled and the application continues to function normally</li> <li>If event publishing fails, the error is logged but does not prevent the authentication flow from completing</li> <li>Each event includes a unique <code>request_id</code> for tracking and debugging</li> </ul>"},{"location":"RABBITMQ_INTEGRATION/#development","title":"Development","text":"<p>To test the integration locally:</p> <ol> <li> <p>Start RabbitMQ:    <code>bash    docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management</code></p> </li> <li> <p>Configure your <code>.env</code> file with RabbitMQ settings</p> </li> <li> <p>Start Verisafe and perform OAuth authentication</p> </li> <li> <p>Check RabbitMQ management interface at <code>http://localhost:15672</code> to see published events</p> </li> </ol>"},{"location":"RABBITMQ_INTEGRATION/#architecture","title":"Architecture","text":"<p>The event bus implementation follows the same pattern as GossipMonger:</p> <ul> <li><code>internal/eventbus/client.go</code> - RabbitMQ connection and basic event bus interface</li> <li><code>internal/eventbus/user_event.go</code> - Event structure definitions</li> <li><code>internal/eventbus/user_event_bus.go</code> - Type-safe event publishing methods</li> </ul> <p>This ensures consistency across the OpenCrafts microservices architecture.</p>"},{"location":"SERVICE_TOKENS/","title":"Service Tokens Implementation","text":"<p>This document describes the implementation of service API keys using industry-standard patterns including rotation, expiry, and security measures.</p>"},{"location":"SERVICE_TOKENS/#overview","title":"Overview","text":"<p>Service tokens are API keys that can only be issued to bot accounts and provide secure access to the Verisafe API. They implement industry-standard security patterns including:</p> <ul> <li>Token Rotation: Automatic and manual token rotation capabilities</li> <li>Expiry Management: Configurable expiration dates</li> <li>Usage Limits: Optional usage count limits</li> <li>IP Whitelisting: Restrict access to specific IP addresses</li> <li>User Agent Validation: Validate client user agents</li> <li>Scope-based Permissions: Fine-grained permission control</li> <li>Audit Logging: Comprehensive usage tracking</li> </ul>"},{"location":"SERVICE_TOKENS/#database-schema","title":"Database Schema","text":""},{"location":"SERVICE_TOKENS/#enhanced-service-tokens-table","title":"Enhanced Service Tokens Table","text":"<p>The <code>service_tokens</code> table includes the following fields:</p> <pre><code>CREATE TABLE service_tokens (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  account_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,\n  name TEXT NOT NULL,\n  description TEXT,\n  token_hash TEXT NOT NULL UNIQUE,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  last_used_at TIMESTAMPTZ,\n  expires_at TIMESTAMPTZ,\n  rotated_at TIMESTAMPTZ,\n  revoked_at TIMESTAMPTZ,\n  scopes TEXT[], -- Array of permission scopes\n  max_uses INTEGER, -- Maximum number of uses (NULL = unlimited)\n  use_count INTEGER DEFAULT 0, -- Current usage count\n  rotation_policy JSONB, -- Rotation policy configuration\n  ip_whitelist TEXT[], -- Allowed IP addresses (NULL = any)\n  user_agent_pattern TEXT, -- Allowed user agent pattern\n  created_by UUID REFERENCES accounts(id), -- Who created this token\n  metadata JSONB -- Additional metadata\n);\n</code></pre>"},{"location":"SERVICE_TOKENS/#key-features","title":"Key Features","text":"<ol> <li>Token Hash: Tokens are stored as SHA256 hashes for security</li> <li>Usage Tracking: <code>use_count</code> tracks how many times the token has been used</li> <li>Rotation Policy: JSONB field stores rotation configuration</li> <li>IP Whitelist: Array of allowed IP addresses</li> <li>User Agent Pattern: Regex pattern for validating user agents</li> <li>Metadata: Flexible JSONB field for additional data</li> </ol>"},{"location":"SERVICE_TOKENS/#api-endpoints","title":"API Endpoints","text":""},{"location":"SERVICE_TOKENS/#service-token-management","title":"Service Token Management","text":""},{"location":"SERVICE_TOKENS/#create-service-token","title":"Create Service Token","text":"<pre><code>POST /api/v1/service-tokens\nAuthorization: Bearer &lt;jwt_token&gt;\nContent-Type: application/json\n\n{\n  \"name\": \"Production API Key\",\n  \"description\": \"API key for production services\",\n  \"expires_in_days\": 365,\n  \"scopes\": [\"read:data\", \"write:data\"],\n  \"max_uses\": 1000,\n  \"rotation_policy\": {\n    \"auto_rotate\": true,\n    \"rotation_interval_days\": 90,\n    \"notify_before_days\": 7\n  },\n  \"ip_whitelist\": [\"192.168.1.100\", \"10.0.0.50\"],\n  \"user_agent_pattern\": \"MyApp/.*\",\n  \"metadata\": {\n    \"environment\": \"production\",\n    \"team\": \"backend\"\n  }\n}\n</code></pre>"},{"location":"SERVICE_TOKENS/#list-service-tokens","title":"List Service Tokens","text":"<pre><code>GET /api/v1/service-tokens\nAuthorization: Bearer &lt;jwt_token&gt;\n</code></pre>"},{"location":"SERVICE_TOKENS/#get-service-token","title":"Get Service Token","text":"<pre><code>GET /api/v1/service-tokens/{id}\nAuthorization: Bearer &lt;jwt_token&gt;\n</code></pre>"},{"location":"SERVICE_TOKENS/#update-service-token","title":"Update Service Token","text":"<pre><code>PUT /api/v1/service-tokens/{id}\nAuthorization: Bearer &lt;jwt_token&gt;\nContent-Type: application/json\n\n{\n  \"name\": \"Updated API Key\",\n  \"description\": \"Updated description\",\n  \"scopes\": [\"read:data\"],\n  \"max_uses\": 500\n}\n</code></pre>"},{"location":"SERVICE_TOKENS/#rotate-service-token","title":"Rotate Service Token","text":"<pre><code>POST /api/v1/service-tokens/{id}/rotate\nAuthorization: Bearer &lt;jwt_token&gt;\n</code></pre>"},{"location":"SERVICE_TOKENS/#revoke-service-token","title":"Revoke Service Token","text":"<pre><code>DELETE /api/v1/service-tokens/{id}\nAuthorization: Bearer &lt;jwt_token&gt;\n</code></pre>"},{"location":"SERVICE_TOKENS/#get-service-token-statistics","title":"Get Service Token Statistics","text":"<pre><code>GET /api/v1/service-tokens/stats\nAuthorization: Bearer &lt;jwt_token&gt;\n</code></pre>"},{"location":"SERVICE_TOKENS/#admin-endpoints","title":"Admin Endpoints","text":""},{"location":"SERVICE_TOKENS/#list-all-service-tokens-admin","title":"List All Service Tokens (Admin)","text":"<pre><code>GET /api/v1/admin/service-tokens\nAuthorization: Bearer &lt;jwt_token&gt;\n</code></pre>"},{"location":"SERVICE_TOKENS/#cleanup-expired-tokens-admin","title":"Cleanup Expired Tokens (Admin)","text":"<pre><code>POST /api/v1/admin/service-tokens/cleanup\nAuthorization: Bearer &lt;jwt_token&gt;\n</code></pre>"},{"location":"SERVICE_TOKENS/#authentication","title":"Authentication","text":""},{"location":"SERVICE_TOKENS/#using-service-tokens","title":"Using Service Tokens","text":"<p>Service tokens are used via the <code>X-API-Key</code> header:</p> <pre><code>GET /api/v1/some-endpoint\nX-API-Key: vst_&lt;token_value&gt;\n</code></pre>"},{"location":"SERVICE_TOKENS/#token-validation","title":"Token Validation","text":"<p>The authentication middleware performs comprehensive validation:</p> <ol> <li>Token Existence: Verifies the token exists in the database</li> <li>Revocation Check: Ensures the token hasn't been revoked</li> <li>Expiration Check: Validates the token hasn't expired</li> <li>Usage Limits: Checks if usage limits have been exceeded</li> <li>IP Whitelist: Validates the client IP against whitelist</li> <li>User Agent: Validates the user agent against the pattern</li> <li>Account Type: Ensures only bot accounts can use service tokens</li> </ol>"},{"location":"SERVICE_TOKENS/#security-features","title":"Security Features","text":""},{"location":"SERVICE_TOKENS/#token-generation","title":"Token Generation","text":"<p>Tokens are generated using cryptographically secure random bytes:</p> <pre><code>func generateSecureToken() (string, error) {\n    bytes := make([]byte, 32)\n    if _, err := rand.Read(bytes); err != nil {\n        return \"\", err\n    }\n\n    token := \"vst_\" + base64.URLEncoding.EncodeToString(bytes)\n    return token, nil\n}\n</code></pre>"},{"location":"SERVICE_TOKENS/#token-hashing","title":"Token Hashing","text":"<p>All tokens are stored as SHA256 hashes:</p> <pre><code>func HashToken(token string) string {\n    hash := sha256.Sum256([]byte(token))\n    return base64.StdEncoding.EncodeToString(hash[:])\n}\n</code></pre>"},{"location":"SERVICE_TOKENS/#ip-validation","title":"IP Validation","text":"<p>The system supports IP whitelisting with proper IP address validation:</p> <pre><code>func isValidIP(ip string) bool {\n    matched, _ := regexp.MatchString(`^(\\d{1,3}\\.){3}\\d{1,3}$`, ip)\n    if !matched {\n        return false\n    }\n\n    parts := strings.Split(ip, \".\")\n    for _, part := range parts {\n        if len(part) &gt; 3 || len(part) == 0 {\n            return false\n        }\n        if part[0] == '0' &amp;&amp; len(part) &gt; 1 {\n            return false\n        }\n    }\n\n    return true\n}\n</code></pre>"},{"location":"SERVICE_TOKENS/#token-rotation","title":"Token Rotation","text":""},{"location":"SERVICE_TOKENS/#automatic-rotation","title":"Automatic Rotation","text":"<p>Tokens can be configured for automatic rotation:</p> <pre><code>{\n  \"rotation_policy\": {\n    \"auto_rotate\": true,\n    \"rotation_interval_days\": 90,\n    \"notify_before_days\": 7\n  }\n}\n</code></pre>"},{"location":"SERVICE_TOKENS/#manual-rotation","title":"Manual Rotation","text":"<p>Tokens can be manually rotated via the API:</p> <pre><code>POST /api/v1/service-tokens/{id}/rotate\nAuthorization: Bearer &lt;jwt_token&gt;\n</code></pre>"},{"location":"SERVICE_TOKENS/#rotation-process","title":"Rotation Process","text":"<ol> <li>Generate new secure token</li> <li>Update token hash in database</li> <li>Reset usage count</li> <li>Update rotation timestamp</li> <li>Return new token to client</li> </ol>"},{"location":"SERVICE_TOKENS/#usage-tracking","title":"Usage Tracking","text":""},{"location":"SERVICE_TOKENS/#usage-statistics","title":"Usage Statistics","text":"<p>The system tracks comprehensive usage statistics:</p> <ul> <li>Total tokens created</li> <li>Active tokens</li> <li>Revoked tokens</li> <li>Expired tokens</li> <li>Recently used tokens (last 30 days)</li> </ul>"},{"location":"SERVICE_TOKENS/#usage-limits","title":"Usage Limits","text":"<p>Tokens can have configurable usage limits:</p> <pre><code>{\n  \"max_uses\": 1000\n}\n</code></pre> <p>When the limit is reached, the token becomes invalid.</p>"},{"location":"SERVICE_TOKENS/#permissions","title":"Permissions","text":""},{"location":"SERVICE_TOKENS/#required-permissions","title":"Required Permissions","text":"<p>Service token operations require specific permissions:</p> <ul> <li><code>create:service_token:own</code> - Create service tokens</li> <li><code>read:service_token:own</code> - Read own service tokens</li> <li><code>list:service_token:own</code> - List own service tokens</li> <li><code>update:service_token:own</code> - Update own service tokens</li> <li><code>rotate:service_token:own</code> - Rotate own service tokens</li> <li><code>revoke:service_token:own</code> - Revoke own service tokens</li> </ul>"},{"location":"SERVICE_TOKENS/#admin-permissions","title":"Admin Permissions","text":"<p>Administrators have additional permissions:</p> <ul> <li><code>read:service_token:any</code> - Read any service tokens</li> <li><code>list:service_token:any</code> - List any service tokens</li> <li><code>update:service_token:any</code> - Update any service tokens</li> <li><code>rotate:service_token:any</code> - Rotate any service tokens</li> <li><code>revoke:service_token:any</code> - Revoke any service tokens</li> </ul>"},{"location":"SERVICE_TOKENS/#background-tasks","title":"Background Tasks","text":""},{"location":"SERVICE_TOKENS/#token-cleanup","title":"Token Cleanup","text":"<p>The system includes background tasks for maintenance:</p> <ol> <li>Expired Token Cleanup: Runs every hour to revoke expired tokens</li> <li>Rotation Check: Runs every 6 hours to mark tokens needing rotation</li> </ol>"},{"location":"SERVICE_TOKENS/#scheduler","title":"Scheduler","text":"<pre><code>type TokenRotationScheduler struct {\n    repo   *repository.Queries\n    logger *slog.Logger\n}\n\nfunc (trs *TokenRotationScheduler) StartScheduler(ctx context.Context) {\n    go trs.runCleanupScheduler(ctx)\n    go trs.runRotationScheduler(ctx)\n}\n</code></pre>"},{"location":"SERVICE_TOKENS/#best-practices","title":"Best Practices","text":""},{"location":"SERVICE_TOKENS/#token-management","title":"Token Management","text":"<ol> <li>Regular Rotation: Rotate tokens every 90 days</li> <li>Scope Limitation: Use minimal required scopes</li> <li>IP Restriction: Whitelist specific IP addresses when possible</li> <li>Usage Monitoring: Monitor token usage patterns</li> <li>Immediate Revocation: Revoke compromised tokens immediately</li> </ol>"},{"location":"SERVICE_TOKENS/#security-considerations","title":"Security Considerations","text":"<ol> <li>Secure Storage: Never store tokens in plain text</li> <li>HTTPS Only: Always use HTTPS for token transmission</li> <li>Logging: Log all token usage for audit purposes</li> <li>Monitoring: Monitor for unusual usage patterns</li> <li>Backup Tokens: Maintain backup tokens for critical services</li> </ol>"},{"location":"SERVICE_TOKENS/#error-handling","title":"Error Handling","text":"<p>The system provides detailed error messages:</p> <ul> <li><code>\"token has been revoked\"</code> - Token was manually revoked</li> <li><code>\"token has expired\"</code> - Token passed its expiration date</li> <li><code>\"token usage limit exceeded\"</code> - Token reached its usage limit</li> <li><code>\"access denied from IP address\"</code> - Client IP not in whitelist</li> <li><code>\"user agent not allowed\"</code> - User agent doesn't match pattern</li> </ul>"},{"location":"SERVICE_TOKENS/#migration","title":"Migration","text":""},{"location":"SERVICE_TOKENS/#running-migrations","title":"Running Migrations","text":"<p>To apply the enhanced service tokens schema:</p> <pre><code>goose up\n</code></pre>"},{"location":"SERVICE_TOKENS/#backward-compatibility","title":"Backward Compatibility","text":"<p>The implementation maintains backward compatibility with existing tokens while adding new features.</p>"},{"location":"SERVICE_TOKENS/#monitoring-and-alerting","title":"Monitoring and Alerting","text":""},{"location":"SERVICE_TOKENS/#key-metrics","title":"Key Metrics","text":"<p>Monitor these key metrics:</p> <ul> <li>Token creation rate</li> <li>Token revocation rate</li> <li>Failed authentication attempts</li> <li>Token usage patterns</li> <li>Rotation success rate</li> </ul>"},{"location":"SERVICE_TOKENS/#alerts","title":"Alerts","text":"<p>Set up alerts for:</p> <ul> <li>High rate of failed authentications</li> <li>Tokens approaching expiration</li> <li>Tokens needing rotation</li> <li>Unusual usage patterns</li> </ul>"},{"location":"SERVICE_TOKENS/#troubleshooting","title":"Troubleshooting","text":""},{"location":"SERVICE_TOKENS/#common-issues","title":"Common Issues","text":"<ol> <li>Token Not Working: Check if token is revoked, expired, or usage limit exceeded</li> <li>IP Access Denied: Verify client IP is in the whitelist</li> <li>User Agent Rejected: Check if user agent matches the pattern</li> <li>Permission Denied: Ensure account has required permissions</li> </ol>"},{"location":"SERVICE_TOKENS/#debug-information","title":"Debug Information","text":"<p>Enable debug logging to troubleshoot authentication issues:</p> <pre><code>logger.SetLevel(slog.LevelDebug)\n</code></pre>"},{"location":"SERVICE_TOKENS/#future-enhancements","title":"Future Enhancements","text":""},{"location":"SERVICE_TOKENS/#planned-features","title":"Planned Features","text":"<ol> <li>Token Analytics: Detailed usage analytics and reporting</li> <li>Webhook Notifications: Notify when tokens need rotation</li> <li>Token Templates: Predefined token configurations</li> <li>Bulk Operations: Bulk token management operations</li> <li>Advanced Scoping: More granular permission scopes</li> </ol>"}]}