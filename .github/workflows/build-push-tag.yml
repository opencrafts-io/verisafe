name: Build, Push, and Update verisafe Backend

on:
  push:
    branches:
      - '**'

jobs:
  build-push-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout verisafe Repo
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.4'
          cache: true

      - name: Install pack CLI
        run: |
          curl -sSL "https://github.com/buildpacks/pack/releases/download/v0.38.2/pack-v0.38.2-linux.tgz" | tar -xz
          sudo mv pack /usr/local/bin/pack

      - name: Cache CNB Layers
        uses: actions/cache@v4
        with:
          path: ~/.cache/pack
          key: cnb-${{ runner.os }}-${{ github.ref }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            cnb-${{ runner.os }}-${{ github.ref }}
            cnb-${{ runner.os }}

      - name: Set Docker Tags
        id: tags
        run: |
          BRANCH=$(echo "${GITHUB_REF##*/}" | tr '[:upper:]' '[:lower:]' | tr '/' '-')
          SHA=$(git rev-parse --short HEAD)

          if [ "$BRANCH" = "main" ]; then
            IMAGE_TAG="prod"
            IMAGE_BASE="${{ secrets.DOCKERHUB_USERNAME }}/verisafe-backend-prod"
          else
            IMAGE_TAG="dev"
            IMAGE_BASE="${{ secrets.DOCKERHUB_USERNAME }}/verisafe-backend-staging"
          fi

          echo "image_base=$IMAGE_BASE" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "sha_tag=$SHA" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build verisafe Image with Buildpacks
        run: |
          IMAGE_BASE=${{ steps.tags.outputs.image_base }}
          IMAGE_TAG=${{ steps.tags.outputs.image_tag }}
          SHA_TAG=${{ steps.tags.outputs.sha_tag }}

          echo "ðŸ”¨ Building $IMAGE_BASE:$IMAGE_TAG and $IMAGE_BASE:$SHA_TAG"

          pack build "$IMAGE_BASE:$IMAGE_TAG" \
            --buildpack paketo-buildpacks/go \
            --builder paketobuildpacks/builder-jammy-base \
            --cache "type=build;format=volume"

          docker tag "$IMAGE_BASE:$IMAGE_TAG" "$IMAGE_BASE:$SHA_TAG"

      - name: Push verisafe Images
        run: |
          IMAGE_BASE=${{ steps.tags.outputs.image_base }}
          IMAGE_TAG=${{ steps.tags.outputs.image_tag }}
          SHA_TAG=${{ steps.tags.outputs.sha_tag }}

          echo "Pushing $IMAGE_BASE:$IMAGE_TAG"
          docker push "$IMAGE_BASE:$IMAGE_TAG"

          echo "Pushing $IMAGE_BASE:$SHA_TAG"
          docker push "$IMAGE_BASE:$SHA_TAG"

      - name: Checkout InfraOps Repo
        uses: actions/checkout@v4
        with:
          repository: opencrafts-io/infraops
          token: ${{ secrets.GH_TOKEN }}
          ref: main
          path: infraops

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Compute deployment file path
        id: target
        run: |
          BRANCH="${GITHUB_REF_NAME#refs/heads/}"
          if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
            FILE="infraops/services/verisafe/deployment.yaml"
          else
            FILE="infraops/qaservices/verisafe/deployment.yaml"
          fi
          echo "file=$FILE" >> "$GITHUB_OUTPUT"
          echo "Deployment file: $FILE"

      - name: Update deployment.yaml
        run: |
          FILE="${{ steps.target.outputs.file }}"
          IMAGE="${{ steps.tags.outputs.image_base }}:${{ steps.tags.outputs.sha_tag }}"
          echo "Updating $FILE with image: $IMAGE"
          if [ ! -f "$FILE" ]; then
            echo "ERROR: $FILE does not exist!"
            ls -la "$(dirname $FILE)"
            exit 1
          fi
          echo "Old image:"
          yq eval '.spec.template.spec.containers[0].image' "$FILE"
          yq eval ".spec.template.spec.containers[0].image = \"$IMAGE\"" -i "$FILE"
          echo "New image:"
          yq eval '.spec.template.spec.containers[0].image' "$FILE"

      - name: Commit and push changes
        run: |
          cd infraops
          IMAGE="${{ steps.tags.outputs.image_base }}:${{ steps.tags.outputs.sha_tag }}"
          git config user.name "CI Bot from Github Actions"
          git config user.email "actions@github.com"
          
          if [ "${{ github.ref_name }}" = "main" ] || [ "${{ github.ref_name }}" = "master" ]; then
            FILE="services/verisafe/deployment.yaml"
          else
            FILE="qaservices/verisafe/deployment.yaml"
          fi
          
          git add "$FILE"
          git commit -m "chore: update verisafe image to $IMAGE (${{ github.ref_name }})"
          git push origin main